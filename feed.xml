<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="https://joshisa.ninja/feed.xml" rel="self" type="application/atom+xml" /><link href="https://joshisa.ninja/" rel="alternate" type="text/html" /><updated>2022-04-30T17:32:47+00:00</updated><id>https://joshisa.ninja/feed.xml</id><title type="html">Ashby’s Hideout</title><subtitle>Sometimes I convert coffee into code. Rubber ducks are awesome.</subtitle><entry><title type="html">Browser Extensions with Rollup - Omnibox Chatter</title><link href="https://joshisa.ninja/2021/10/22/browser-extension-with-rollup-omnibox-chatter.html" rel="alternate" type="text/html" title="Browser Extensions with Rollup - Omnibox Chatter" /><published>2021-10-22T00:00:00+00:00</published><updated>2021-10-22T00:00:00+00:00</updated><id>https://joshisa.ninja/2021/10/22/browser-extension-with-rollup-omnibox-chatter</id><content type="html" xml:base="https://joshisa.ninja/2021/10/22/browser-extension-with-rollup-omnibox-chatter.html"><![CDATA[<div>
  <em>
  This post contains inline annotations/footnotes to help add context, helpful tips or expand upon a tangent in the text. Expand them by <a href="#annotation-1" class="annotation-trigger -gray">clicking or tapping on them</a>
<span id="annotation-1" class="annotation">Annotations might have their own <a href="#annotation-2" class="annotation-trigger -red">annotations</a><span id="annotation-2" class="annotation">Such as this one!</span> inside of them too.</span>

  </em>
</div>

<p>In the <a href="/2021/10/16/web-extensions-with-rollup-getting-started.html">previous post</a>, we laid down the groundwork for building a browser extension using <a href="https://rollupjs.org/">Rollup.js</a> that logged “Hello, World!” out to the extensions background page’s console. Today we’ll take that idea a little further and start to tie into the browser’s “Omnibox,” which will let the browser give our extension the users input into the URL bar after they’ve entered a keyword with which we’ll register in the extensions <code class="language-plaintext highlighter-rouge">manifest.json</code>. As part of this, we’ll set up TypeScript and a polyfill to help us out.</p>

<p>As a reminder of what we’re building through this series: A simple browser extension that allows for the creation of “aliases” via the URL bar, e.g., if the browser extension registers <code class="language-plaintext highlighter-rouge">goto</code> as the keyword, the user could set up the alias <code class="language-plaintext highlighter-rouge">github/me</code> to go to their GitHub profile and type in <code class="language-plaintext highlighter-rouge">goto github/me</code> to the URL bar to make use of the alias; Similar to <a href="https://github.com/einaregilsson/Redirector">Redirector</a>.</p>

<p>Along the way, we’ll cover an introduction to browser extensions, talk about making them function under both Chrome and Firefox with minimal changes and how to use tools like Rollup.js to help bundle one.</p>

<p class="callout blue">While I’m writing these posts using my own preferences on techniques and technologies (which include Rollup.js as well as <a href="https://www.typescriptlang.org/">TypeScript</a>, <a href="https://svelte.dev/">Svelte</a>), there are a lot of alternative approaches, and it’s the concepts that are the core take away. Nothing precludes you from using different technologies; if you’d like to follow along using Vanilla ES6+ and <a href="https://esbuild.github.io/">esbuild</a>, or any other number of setups, <a href="#annotation-3" class="annotation-trigger -purple">go right ahead!</a>
<span id="annotation-3" class="annotation">For example, I’ve been meaning to mess around with <a href="https://www.solidjs.com/">Solid.js</a> or <a href="https://rescript-lang.org/">Rescript w/ React</a>. Maybe even replace Rollup.js with esbuild or <a href="https://swc.rs/">swc</a>. All of which shouldn’t be too difficult to adapt this series for.</span></p>

<h3 id="typescript">TypeScript</h3>

<p>As I eluded to above, this step is optional. Still, I personally find that TypeScript (TS) makes it easier for me to come back to projects after a long hiatus, helps eliminate several common bug types resulting from duck typing and generally helps speed up my development. TypeScript is easy to convert to JavaScript by removing the types (the occasional enum might need some tweaks to make it an object, too, but that shouldn’t be a show stopper). Even if TypeScript is not your cup of tea, it should be easy to follow along still.</p>

<p>We’ll need both TypeScript as well as the Rollup TypeScript plugin:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm add <span class="nt">--save-dev</span> @rollup/plugin-typescript typescript
</code></pre></div></div>

<p>Then we’ll need to add the plugin to our <code class="language-plaintext highlighter-rouge">rollup.config.js</code>, add the import somewhere near the top:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><div class="emphasized"><span class="k">import</span> <span class="nx">copy</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">rollup-plugin-copy</span><span class="dl">"</span>

<span class="hll"><span class="k">import</span> <span class="nx">typescript</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rollup/plugin-typescript</span><span class="dl">"</span>
</span>
<span class="kd">const</span> <span class="nx">production</span> <span class="o">=</span> <span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ROLLUP_WATCH</span></div></code></pre></figure>

<p>And set up the plugin after the <code class="language-plaintext highlighter-rouge">commonjs</code> plugin:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><div class="emphasized">      <span class="nx">resolve</span><span class="p">({</span> <span class="na">browser</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">preferBuiltins</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}),</span>
      <span class="nx">commonjs</span><span class="p">(),</span>

<span class="hll">      <span class="nx">typescript</span><span class="p">({</span> <span class="na">sourceMap</span><span class="p">:</span> <span class="o">!</span><span class="nx">production</span><span class="p">,</span> <span class="na">inlineSources</span><span class="p">:</span> <span class="o">!</span><span class="nx">production</span> <span class="p">}),</span>
</span>
      <span class="nx">copy</span><span class="p">({</span></div></code></pre></figure>

<p>We’re configuring the source maps to generate in development builds and telling TypeScript to <a href="https://www.typescriptlang.org/tsconfig/#inlineSources">inline the original TS source</a> into the source map. I find the inlining of the source helps the browsers to be able to display the source and line/column numbering <a href="#annotation-4" class="annotation-trigger -gray">without issue.</a>
<span id="annotation-4" class="annotation">Without needing to set up a source directory mapping, something I’ve never had function well. YMMV.</span></p>

<p>Next, we’ll add the start of our <code class="language-plaintext highlighter-rouge">tsconfig.json</code>. You can do this in several ways, such as running <code class="language-plaintext highlighter-rouge">npm exec tsc -- --init</code>, but I have a starter version that I use, which closely aligns with the Svelte TSConfig (which we’ll make use of in a future post) and plays nicely with Rollup:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"exclude"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"node_modules/*"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"dist/*"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"web-ext/*"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"ext-dev/*"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"include"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"src/**/*.ts"</span><span class="w"> </span><span class="p">],</span><span class="w">
  </span><span class="nl">"compilerOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"strict"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"target"</span><span class="p">:</span><span class="w"> </span><span class="s2">"es2020"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"module"</span><span class="p">:</span><span class="w"> </span><span class="s2">"es2020"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"moduleResolution"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"isolatedModules"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"esModuleInterop"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"allowSyntheticDefaultImports"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"forceConsistentCasingInFileNames"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"resolveJsonModule"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"skipLibCheck"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>For a reference on all the options available, please refer to the <a href="https://www.typescriptlang.org/tsconfig"><code class="language-plaintext highlighter-rouge">tsconfig.json</code> docs</a>.</p>

<p>We’ll need to also adjust our <code class="language-plaintext highlighter-rouge">src/background/index.js</code> to be a TypeScript file. Rename it to <code class="language-plaintext highlighter-rouge">src/background/index.ts</code>, then add <code class="language-plaintext highlighter-rouge">export default undefined</code> to the end. You might want to change up the <code class="language-plaintext highlighter-rouge">console.log</code> message as well if you’d like to see that TypeScript is working.</p>

<p>Why do we need <code class="language-plaintext highlighter-rouge">export default undefined</code>? We’ve configured TypeScript with <a href="https://www.typescriptlang.org/tsconfig#isolatedModules"><code class="language-plaintext highlighter-rouge">isolatedModules</code></a> turned on, which we’ll need for Svelte in future posts as the Svelte pre-processor that handles TypeScript in Svelte files only works on a file-by-file basis and, as the <code class="language-plaintext highlighter-rouge">isolatedModules</code>  docs say:</p>

<blockquote>
  <p>[…] other transpilers only operate on a single file at a time, which means they can’t apply code transforms that depend on understanding the full type system.</p>
</blockquote>

<p>Without this, you might see this warning pop up in the Rollup output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rollup v2.52.7
bundles src/background/index.ts → dist/background...
(!) Plugin typescript: @rollup/plugin-typescript TS1208: 'index.ts' cannot be compiled under '--isolatedModules' because it is considered a global script file. Add an import, export, or an empty 'export {}' statement to make it a module.
src/background/index.ts: (1:1)

1 console.log("Hello, World! From TS!")
  ~~~~~~~

created dist/background in 1s

[2021-10-23 20:12:54] waiting for changes...
</code></pre></div></div>

<p>One last change that we need to make is to change the extension in the <code class="language-plaintext highlighter-rouge">input</code> for the background page’s entry point to <code class="language-plaintext highlighter-rouge">.ts</code> so that Rollup can find the file correctly:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><div class="emphasized"><span class="k">export</span> <span class="k">default</span> <span class="p">[</span>
  <span class="p">{</span>
<span class="hll">    <span class="na">input</span><span class="p">:</span> <span class="dl">"</span><span class="s2">src/background/index.ts</span><span class="dl">"</span><span class="p">,</span>
</span>    <span class="na">output</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">sourcemap</span><span class="p">:</span> <span class="o">!</span><span class="nx">production</span><span class="p">,</span>
      <span class="na">dir</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dist/background/</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">format</span><span class="p">:</span> <span class="dl">"</span><span class="s2">esm</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">},</span></div></code></pre></figure>

<p>Now <code class="language-plaintext highlighter-rouge">npm run start:rollup</code> should run without issue, and <a href="#annotation-5" class="annotation-trigger -gray">reloading the extension</a>
<span id="annotation-5" class="annotation">In Firefox, the debugging page that we used to load the extension in the previous post, <code class="language-plaintext highlighter-rouge">about:debugging#/runtime/this-firefox</code>, will display a small “Reload” button on the bottom right corner of the extensions card:<img src="/assets/2021-10-22-browser-extension-with-rollup-omnibox-chatter/firefox-reload.png" alt="" />For Chrome, the extensions page that we used to load the unpacked extension, <code class="language-plaintext highlighter-rouge">chrome://extensions/</code>, will display a small “Reload” <em>icon</em> button on the bottom right corner of the extensions card:<img src="/assets/2021-10-22-browser-extension-with-rollup-omnibox-chatter/chrome-reload.png" alt="" /></span>
 in your browser should cause your <code class="language-plaintext highlighter-rouge">console.log</code> message to show up as before:</p>

<p><img src="/assets/2021-10-22-browser-extension-with-rollup-omnibox-chatter/typescript-console.png" alt="" /></p>

<p>Not only that, the browser should correctly show the original filename, <code class="language-plaintext highlighter-rouge">index.ts</code> and even the original TS file’s source!</p>

<h3 id="polyfills">Polyfills</h3>

<p>Before we get any further, we’re going to add a polyfill for the browser extensions API that Mozilla provides, allowing us to use the <code class="language-plaintext highlighter-rouge">browser</code> promise-based APIs, even while running the browser extension in Chrome.</p>

<p>Why do we need such a thing, you might ask? Great question! As it turns out, Chrome’s browser extension API is an <a href="#annotation-6" class="annotation-trigger -gray">older generation</a>
<span id="annotation-6" class="annotation">The OG, in fact!</span>
 and makes use of a <code class="language-plaintext highlighter-rouge">chrome</code> namespace (ie: <code class="language-plaintext highlighter-rouge">chrome.storage.sync</code>) which uses callbacks for async operations.</p>

<p><strong>Record Scratch</strong> Yes, I did just say “callbacks for async operations.” Yes, we’re in a post ES6 world where JavaScript has <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">promises</a> and <code class="language-plaintext highlighter-rouge">async</code>/<code class="language-plaintext highlighter-rouge">await</code> keywords for working with them in a friendly, <em>synchronous like</em> fashion that solves a significant amount of the problems that lead to, and result from, Callback Hell.</p>

<p>On the other hand, Firefox ships with a <a href="#annotation-7" class="annotation-trigger -gray">more modern</a>
<span id="annotation-7" class="annotation">And maybe soon <a href="https://www.w3.org/community/webextensions/">standards track</a></span>
, generation of the original Chrome API. This version lives under the <code class="language-plaintext highlighter-rouge">browser</code> namespace and uses promises for async operations. Thankfully, the fine folks at Mozilla maintain a <a href="https://github.com/mozilla/webextension-polyfill">polyfill</a> for Chrome which allows you to use the <code class="language-plaintext highlighter-rouge">browser</code> and promise-based API’s so we can write modern code once that runs on both browsers.</p>

<p>Add it to our dependencies with <code class="language-plaintext highlighter-rouge">npm add</code> like always (I’m not saving it under the dev dependencies this time, as it’s a required runtime module that we’ll actively import into our code):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm add webextension-polyfill
</code></pre></div></div>

<p>To test it out, we’ll make use of the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/id"><code class="language-plaintext highlighter-rouge">browser.runtime.id</code></a> call in our <code class="language-plaintext highlighter-rouge">console.log</code>, which should print out a nice random string that <a href="#annotation-8" class="annotation-trigger -gray">represents the ID of the extension.</a>
<span id="annotation-8" class="annotation">This is customizable in Firefox, via the <code class="language-plaintext highlighter-rouge">browser_specific_settings.gecko.id</code> property of the manifest, the docs for which are <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/browser_specific_settings">found here</a>.</span>
 Update <code class="language-plaintext highlighter-rouge">src/background/index.ts</code> file to look like the following:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">browser</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">webextension-polyfill</span><span class="dl">"</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Hello, World! From TS! </span><span class="p">${</span><span class="nx">browser</span><span class="p">.</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="the-trouble-with-tribbles-types">The Trouble with <del>Tribbles</del> Types</h4>

<p>If you’re using TypeScript, you might notice this fun warning show up in the Rollup output, and you might have an error in your editor for the same issue:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(!) Plugin typescript: @rollup/plugin-typescript TS7016: Could not find a declaration file for module 'webextension-polyfill'. '/Users/joshashby/repos/personal/svelte-web-extension-tutorial/node_modules/webextension-polyfill/dist/browser-polyfill.js' implicitly has an 'any' type.
  Try `npm i --save-dev @types/webextension-polyfill` if it exists or add a new declaration (.d.ts) file containing `declare module 'webextension-polyfill';`
</code></pre></div></div>

<p>This is where I found things get a little hairy right now. There are a <a href="https://www.npmjs.com/package/@types/webextension-polyfill">couple of</a> <a href="https://www.npmjs.com/package/web-ext-types">packges</a> that supply types for the <code class="language-plaintext highlighter-rouge">browser</code> API’s and for the <a href="#annotation-9" class="annotation-trigger -gray">polyfill</a>
<span id="annotation-9" class="annotation"><code class="language-plaintext highlighter-rouge">@types/webextension-polyfill</code> Sounds great at first, but I’ve found it has some missing or oddly typed APIs and many instances of various objects being a nebulous <code class="language-plaintext highlighter-rouge">any</code>, which isn’t super helpful for a well-defined set of APIs like this.</span>
, however the most complete and up-to-date one that I use is <a href="https://www.npmjs.com/package/@types/firefox-webext-browser"><code class="language-plaintext highlighter-rouge">@types/firefox-webext-browser</code></a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm add <span class="nt">--save-dev</span> @types/firefox-webext-browser
</code></pre></div></div>

<p>Unfortunately, installing this package doesn’t get you very far. The import error for <code class="language-plaintext highlighter-rouge">webextension-polyfill</code> will remain, as this package only declares types for a global <code class="language-plaintext highlighter-rouge">browser</code> object. This also has the downside of TypeScript thinking <code class="language-plaintext highlighter-rouge">browser</code> is defined, regardless of if you’ve remembered to import <code class="language-plaintext highlighter-rouge">webextension-polyfill</code> or not. So how do we get around this?</p>

<p>Well … We hack it. This is the real ugly bit and abuses TypeScript a bit, but we’re going to make an <a href="https://www.typescriptlang.org/docs/handbook/namespaces.html#working-with-other-javascript-libraries">ambient definition</a>, by creating a <code class="language-plaintext highlighter-rouge">src/polyfill-types.d.ts</code> file with the following contents:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="kd">type</span> <span class="nx">browser</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@types/firefox-webext-browser</span><span class="dl">"</span>

<span class="kr">declare</span> <span class="kr">module</span> <span class="dl">"</span><span class="s2">webextension-polyfill</span><span class="dl">"</span> <span class="p">{</span>
  <span class="k">export</span> <span class="k">default</span> <span class="nx">browser</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We use an ambient <code class="language-plaintext highlighter-rouge">.d.ts</code> file since TypeScript will pick it up without any additional work from us, and we define the default export of the polyfill as being typed by the type export of the <code class="language-plaintext highlighter-rouge">@types/firefox-webext-browser</code> package.</p>

<p>With this out of the way, the TypeScript warning should resolve, and reloading the extension should yield our new <code class="language-plaintext highlighter-rouge">console.log</code> message:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello, World! From TS! e7f1b7ad5057a435952272be6270dbf6b16867fe@temporary-addon
</code></pre></div></div>

<h3 id="so-whats-the-omnibox">So, What’s the Omnibox?</h3>

<p>Now that we have our polyfill in place (and some of you have TypeScript up and running), we can get on with our original goal for today: Integrating with the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/omnibox">Omnibox</a> (The Omnibox might be more recognizable to you as the URL bar) and browser extensions are allowed to register a keyword with the browser, which, when typed into the Omnibox, will cause the browser to begin sending the contents of the Omnibox to your extension.</p>

<p>To get started, we’ll follow the directions of the Omnibox docs and add an <code class="language-plaintext highlighter-rouge">omnibox</code> section to our <code class="language-plaintext highlighter-rouge">manifest.json</code>, where we’ll also <a href="#annotation-10" class="annotation-trigger -gray">define our keyword.</a>
<span id="annotation-10" class="annotation">I chose <code class="language-plaintext highlighter-rouge">vrm</code>, short for <code class="language-plaintext highlighter-rouge">vroom</code>, but this can be just about any word</span></p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><div class="emphasized"><span class="w">  </span><span class="nl">"background"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nl">"page"</span><span class="p">:</span><span class="w"> </span><span class="s2">"background/index.html"</span>
<span class="w">  </span><span class="p">}</span><span class="err">,</span>
<span class="hll"><span class="w">  </span><span class="nl">"omnibox"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">    </span><span class="nl">"keyword"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vrm"</span>
</span><span class="hll"><span class="w">  </span><span class="p">}</span>
</span><span class="p">}</span></div></code></pre></figure>

<p>With this in place, we can now start hooking up to the <code class="language-plaintext highlighter-rouge">omnibox</code> API. We’ll use the extension’s background page to register event listeners and handle the subsequent events since the background page will run at all times and has the highest level of permissions for accessing parts of the browser extension API.</p>

<p>This API <a href="#annotation-11" class="annotation-trigger -gray">is event-driven</a>
<span id="annotation-11" class="annotation">The browser extension APIs where an extension might react to something happening in the browser are all exposed as events, using the same interface consisting of the functions <code class="language-plaintext highlighter-rouge">addEventListener</code>, <code class="language-plaintext highlighter-rouge">hasEventListener</code>/<code class="language-plaintext highlighter-rouge">hasEventListeners</code> and <code class="language-plaintext highlighter-rouge">removeEventListener</code>, which all take a callback function which is the event subscriber.</span>
, and in particular, for the <code class="language-plaintext highlighter-rouge">omnibox</code>, there are 4 events we can listen for:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">onInputStarted</code> Called with no arguments when the user has typed in the full keyword followed by a space</li>
  <li><code class="language-plaintext highlighter-rouge">onInputChanged</code> Called with the current input and a callback that allows setting suggestions</li>
  <li><code class="language-plaintext highlighter-rouge">onInputEntered</code> Called when the user accepts one of the suggestions</li>
  <li><code class="language-plaintext highlighter-rouge">onInputCancelled</code> Called when the user escapes/closes the omnibox</li>
</ul>

<p>We’ll only use <code class="language-plaintext highlighter-rouge">onInputChanged</code> and <code class="language-plaintext highlighter-rouge">onInputEntered</code> for our extension, but to demonstrate the others and get a sense of how this API works, we’ll add some basic logging. Add the following to the end of <code class="language-plaintext highlighter-rouge">src/background/index.ts</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">browser</span><span class="p">.</span><span class="nx">omnibox</span><span class="p">.</span><span class="nx">onInputStarted</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Input started</span><span class="dl">"</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">browser</span><span class="p">.</span><span class="nx">omnibox</span><span class="p">.</span><span class="nx">onInputChanged</span><span class="p">.</span><span class="nx">addListener</span><span class="p">((</span><span class="nx">input</span><span class="p">,</span> <span class="nx">suggest</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Input changed! </span><span class="p">${</span><span class="nx">input</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  
  <span class="nx">suggest</span><span class="p">([</span>
    <span class="p">{</span> <span class="na">content</span><span class="p">:</span> <span class="dl">"</span><span class="s2">s1</span><span class="dl">"</span><span class="p">,</span> <span class="na">description</span><span class="p">:</span> <span class="dl">"</span><span class="s2">This is suggestion 1</span><span class="dl">"</span> <span class="p">},</span>
    <span class="p">{</span> <span class="na">content</span><span class="p">:</span> <span class="dl">"</span><span class="s2">s2</span><span class="dl">"</span><span class="p">,</span> <span class="na">description</span><span class="p">:</span> <span class="dl">"</span><span class="s2">This is suggestion 2</span><span class="dl">"</span> <span class="p">},</span>
    <span class="p">{</span> <span class="na">content</span><span class="p">:</span> <span class="dl">"</span><span class="s2">s3</span><span class="dl">"</span><span class="p">,</span> <span class="na">description</span><span class="p">:</span> <span class="dl">"</span><span class="s2">This is suggestion 3</span><span class="dl">"</span> <span class="p">},</span>
    <span class="p">{</span> <span class="na">content</span><span class="p">:</span> <span class="dl">"</span><span class="s2">s4</span><span class="dl">"</span><span class="p">,</span> <span class="na">description</span><span class="p">:</span> <span class="dl">"</span><span class="s2">This is suggestion 4</span><span class="dl">"</span> <span class="p">},</span>
  <span class="p">])</span>
<span class="p">})</span>

<span class="nx">browser</span><span class="p">.</span><span class="nx">omnibox</span><span class="p">.</span><span class="nx">onInputEntered</span><span class="p">.</span><span class="nx">addListener</span><span class="p">((</span><span class="nx">suggestion</span><span class="p">,</span> <span class="nx">disposition</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Input entered! </span><span class="p">${</span><span class="nx">suggestion</span><span class="p">}</span><span class="s2"> should open in </span><span class="p">${</span><span class="nx">disposition</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">browser</span><span class="p">.</span><span class="nx">omnibox</span><span class="p">.</span><span class="nx">onInputCancelled</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Input cancelled</span><span class="dl">"</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>After reloading the extension, by typing in your keyword to the URL bar, you should trigger the logging statements and see the suggestions we put in place.</p>

<h5 id="firefox">Firefox</h5>
<p><img src="/assets/2021-10-22-browser-extension-with-rollup-omnibox-chatter/firefox-omnibox-test.png" alt="" /></p>

<p><img src="/assets/2021-10-22-browser-extension-with-rollup-omnibox-chatter/firefox-omnibox-console.png" alt="" /></p>

<h5 id="chrome">Chrome</h5>
<p><img src="/assets/2021-10-22-browser-extension-with-rollup-omnibox-chatter/chrome-omnibox-test.png" alt="" /></p>

<p><img src="/assets/2021-10-22-browser-extension-with-rollup-omnibox-chatter/chrome-omnibox-console.png" alt="" /></p>

<p>The heart of what we’ll be expanding upon in future posts of this series is this little bit with <code class="language-plaintext highlighter-rouge">suggest</code> here:</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><div class="emphasized"><span class="nx">browser</span><span class="p">.</span><span class="nx">omnibox</span><span class="p">.</span><span class="nx">onInputChanged</span><span class="p">.</span><span class="nx">addListener</span><span class="p">((</span><span class="nx">text</span><span class="p">,</span> <span class="nx">suggest</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Input changed! </span><span class="p">${</span><span class="nx">text</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
  
<span class="hll">  <span class="nx">suggest</span><span class="p">([</span>
</span><span class="hll">    <span class="p">{</span> <span class="na">content</span><span class="p">:</span> <span class="dl">"</span><span class="s2">s1</span><span class="dl">"</span><span class="p">,</span> <span class="na">description</span><span class="p">:</span> <span class="dl">"</span><span class="s2">This is suggestion 1</span><span class="dl">"</span> <span class="p">},</span>
</span><span class="hll">    <span class="p">{</span> <span class="na">content</span><span class="p">:</span> <span class="dl">"</span><span class="s2">s2</span><span class="dl">"</span><span class="p">,</span> <span class="na">description</span><span class="p">:</span> <span class="dl">"</span><span class="s2">This is suggestion 2</span><span class="dl">"</span> <span class="p">},</span>
</span><span class="hll">    <span class="p">{</span> <span class="na">content</span><span class="p">:</span> <span class="dl">"</span><span class="s2">s3</span><span class="dl">"</span><span class="p">,</span> <span class="na">description</span><span class="p">:</span> <span class="dl">"</span><span class="s2">This is suggestion 3</span><span class="dl">"</span> <span class="p">},</span>
</span><span class="hll">    <span class="p">{</span> <span class="na">content</span><span class="p">:</span> <span class="dl">"</span><span class="s2">s4</span><span class="dl">"</span><span class="p">,</span> <span class="na">description</span><span class="p">:</span> <span class="dl">"</span><span class="s2">This is suggestion 4</span><span class="dl">"</span> <span class="p">},</span>
</span><span class="hll">  <span class="p">])</span>
</span><span class="p">})</span></div></code></pre></figure>

<p>Listeners for <code class="language-plaintext highlighter-rouge">onInputChanged</code> receive two arguments, <code class="language-plaintext highlighter-rouge">text</code> and <code class="language-plaintext highlighter-rouge">suggest</code>. <code class="language-plaintext highlighter-rouge">text</code> is the full text, minus the keyword and space, that the user has typed, while <code class="language-plaintext highlighter-rouge">suggest</code> is a callback that accepts an array of <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/omnibox/SuggestResult"><code class="language-plaintext highlighter-rouge">SuggestResult</code></a>. A <code class="language-plaintext highlighter-rouge">SuggestResult</code> is just an object with two properties, <code class="language-plaintext highlighter-rouge">content</code> and <code class="language-plaintext highlighter-rouge">description</code>. <code class="language-plaintext highlighter-rouge">description</code> is, understandably, only for the users, however <code class="language-plaintext highlighter-rouge">content</code> represents the actual “value” of the suggestion, and if the user were to accept that suggestion, <code class="language-plaintext highlighter-rouge">content</code> is what the extension will receive in it’s <code class="language-plaintext highlighter-rouge">onInputEntered</code> listener.</p>

<p>In the future, we’ll use this bit of knowledge to build out our alias functionality, displaying matching aliases and the URL that they map to as the description.</p>

<h2 id="wrapping-up">Wrapping Up</h2>

<p>We laid down some good foundations for building our extension, but it still doesn’t do much; Currently, it registers a keyword with the browser for the Omnibox and prints out the events to the console. In the next post, we’ll finish the last bit of setup for a while: installing and configuring Svelte, and then use it to make a basic settings page. After that, we’ll be able to start interacting with the browser extension <code class="language-plaintext highlighter-rouge">storage</code> APIs to read/write our aliases. Finally, we’ll be able to hook up our work here with the <code class="language-plaintext highlighter-rouge">omnibox</code> API to our new settings to be able to suggest, and act upon, those aliases!</p>]]></content><author><name></name></author><category term="browser-extension" /><category term="rollupjs" /><category term="typescript" /><summary type="html"><![CDATA[This post contains inline annotations/footnotes to help add context, helpful tips or expand upon a tangent in the text. Expand them by clicking or tapping on them Annotations might have their own annotationsSuch as this one! inside of them too.]]></summary></entry><entry><title type="html">Browser Extensions with Rollup - Getting Started</title><link href="https://joshisa.ninja/2021/10/16/web-extensions-with-rollup-getting-started.html" rel="alternate" type="text/html" title="Browser Extensions with Rollup - Getting Started" /><published>2021-10-16T00:00:00+00:00</published><updated>2021-10-16T00:00:00+00:00</updated><id>https://joshisa.ninja/2021/10/16/web-extensions-with-rollup-getting-started</id><content type="html" xml:base="https://joshisa.ninja/2021/10/16/web-extensions-with-rollup-getting-started.html"><![CDATA[<div>
  <em>
  This post contains inline annotations/footnotes to help add context, helpful tips or expand upon a tangent in the text. Expand them by <a href="#annotation-1" class="annotation-trigger -gray">clicking or tapping on them</a>
<span id="annotation-1" class="annotation">Annotations might have their own <a href="#annotation-2" class="annotation-trigger -red">annotations</a><span id="annotation-2" class="annotation">Such as this one!</span> inside of them too.</span>

  </em>
</div>

<p><em>Updated 2021-Oct-23 to cleanup some wording and adjust some formatting things</em></p>

<p>I’ve built a number of personal and work related browser extensions over the years and, consequentally, I’ve tried a number of different patterns for building extensions. For simpler extensions the modern and lightweight <a href="http://vanilla-js.com/">Vanilla JS</a> can take you pretty far, but sometimes more advanced tooling (or at least more “comfortable” tooling) is either necessary, or at a minimum, desired. For me, it’s the latter. I prefer to use <a href="https://www.typescriptlang.org/">TypeScript</a>, <a href="https://svelte.dev/">Svelte</a> and <a href="https://tailwindcss.com/">Tailwind CSS</a> as I feel more productive with them and they afford me the developer experience that fits me best at this point in time.</p>

<p>When making the leap from Vanilla JS, one of the first problems that comes up is how to bundle your code which leads to a myriad of choices ranging from older but steady Gulp setups, to stable Webpack all the way to newer and wave making Vite. Often times however, this space lacks attention to brower extension development flows, or presents patterns that are completely incompatable. Historically I’ve used a Parcel v1 setup, toyed with Webpack and Parcel v2, but over the last two and half years I’ve been starting new projects, and transitioning old ones, to using <a href="https://rollupjs.org/">Rollup.js</a> because it provides me with the best over all experience for my needs.</p>

<p>Unfortunately, there wasn’t much documentation about getting started with building browser extensions using Rollup.js when I started down this path, and the limited options of plugins and configuration builders that exist often target Chrome/Chromium based browsers only, and have a host of issues with building usable extensions for Firefox. For me, these are deal breakers as I use Firefox as my daily driver browser, and most of my extensions are personal use extensions so I need first class support for Firefox. Consequentally, I’ve had to forge my own path and figure this out as I go, and I figured I could document some of my learnings, or at least the final process, so today: we’ll lay down the ground work and build a basic browser extension using plain old Rollup.js.</p>
<h2 id="what-well-build-today">What We’ll Build Today</h2>
<p>We’ll be setting up Rollup.js with some common plugins that will build a basic browser extension; The browser extension will be simple for now, mearly a background page that logs “Hello, World” to the console. We’ll also cover how to install your browser extension and test it out in both Firefox and Chrome.</p>

<p>In future posts we’ll explore building additional functionality that’ll culminate in an extension that: registers a keyword trigger with the browser’s URL bar, allows you to configure a set of “aliases” and will redirect you to those aliases when the keyword and alias are typed into the URL bar.</p>

<p>The complete extension will explore background pages, storage in extensions, dedicated pages within the extension for settings, and working with the browsers “web-extension” API. There might be some interludes along the way as well, including: injecting UI into a webpage and showing a popup from the browser action, among others.</p>

<p class="callout info"><strong>Note</strong> This extension will be built as a “Manifest v2” extension. While this extension should work just fine in Manifest v3 land, due to lack of non-chrome browser support and Googles apparent intent of <a href="https://www.theregister.com/2021/09/27/google_chrome_manifest_v2_extensions/">ramming through v3</a> to try and styme the danger of ad blockers harming their business, under the guise of “security and performance,” <a href="#annotation-3" class="annotation-trigger -gray">I will not be covering v3 topics at this time and will be focusing on v2 extensions.</a>
<span id="annotation-3" class="annotation">While I want everyone to go and research the topics to formulate their own opinions, I would recommend a few reading points, including <a href="https://www.theregister.com/2021/09/27/google_chrome_manifest_v2_extensions/">The Register on the cut to V3</a>, and Rich Harris’ posts <a href="https://dev.to/richharris/in-defense-of-the-modern-web-2nia">In defense of the modern web</a> and <a href="https://dev.to/richharris/stay-alert-d">Stay Alert</a>, on my beliefs about why Google may not be the bastion of good for todays Web that they claim to be.</span></p>

<h2 id="preparations">Preparations</h2>
<p>After we’re done today, our directory should look something like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── src
│   ├── assets
│   ├── background
│   │   ├── index.html
│   │   └── index.js
│   └── manifest.json
├── package-lock.json
├── package.json
├── rollup.config.js
</code></pre></div></div>

<p>And we’ll have a browser extension that loads a basic background page that logs “Hello, World” to the console.</p>

<p>A background page is used in browser extensions to implement long running logic and shared state between tabs, you can read more about them on <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Anatomy_of_a_WebExtension#background_scripts">MDN here</a>. Our extension today won’t make heavy use of the background script for now, but we’ll expand on uses for it in future posts.</p>

<!-- tree -v --dirsfirst -I 'node_modules' -->

<p>Make a directory where ever best fits for you and cd into it:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>web-ext <span class="o">&amp;&amp;</span> <span class="nb">cd </span>web-ext
</code></pre></div></div>

<p>Go ahead and make <code class="language-plaintext highlighter-rouge">src/</code> and <code class="language-plaintext highlighter-rouge">src/assets/</code> in this directory too, as they’ll come in handy later:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> src/assets/
</code></pre></div></div>

<p>(The <code class="language-plaintext highlighter-rouge">-p</code> flag will create <code class="language-plaintext highlighter-rouge">src/</code> if it doesn’t exist before creating <code class="language-plaintext highlighter-rouge">src/assets/</code>)</p>

<p>Then place the following into <code class="language-plaintext highlighter-rouge">package.json</code> and change the fields as necessary. We’ll add to the scripts later on but it’s okay to be left empty for now (You can also create this file by running <code class="language-plaintext highlighter-rouge">npm init</code> and answering the questions).</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"web-ext"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"author"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
  </span><span class="nl">"license"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ISC"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="setup---rollup">Setup - Rollup</h2>
<p>Next lets install Rollup and some common plugins that we’ll come in handy down the line:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">@rollup/plugin-commonjs</code> Allows us to use CommonJS modules in our builds, especially for non-content scripts which will be bundled as ES modules.</li>
  <li><code class="language-plaintext highlighter-rouge">@rollup/plugin-node-resolve</code> Along with the CommonJS plugin, this allows us to import packages installed with NPM.</li>
  <li><code class="language-plaintext highlighter-rouge">@rollup/plugin-replace</code> To handle replacing common patterns, words and calls with a predefined format, such as replacing <code class="language-plaintext highlighter-rouge">process.env.NODE_ENV</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">rollup-plugin-copy</code> Will help us copy assets and the manifest file to our build directory.</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm i rollup @rollup/plugin-commonjs @rollup/plugin-node-resolve @rollup/plugin-replace rollup-plugin-copy <span class="nt">--save-dev</span>
</code></pre></div></div>

<p>We’ll add more plugins as we go but this’ll get us setup and running for now. Next we need to add some basic setup to our <code class="language-plaintext highlighter-rouge">rollup.config.js</code> to get our background page script <code class="language-plaintext highlighter-rouge">src/background/index.js</code> compiling. Today we won’t do much with the background page script, but I’m using it here to get us up and running and we’ll expand on some use of it in future posts.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">commonjs</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rollup/plugin-commonjs</span><span class="dl">"</span>
<span class="k">import</span> <span class="nx">replace</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rollup/plugin-replace</span><span class="dl">"</span>
<span class="k">import</span> <span class="nx">resolve</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rollup/plugin-node-resolve</span><span class="dl">"</span>
<span class="k">import</span> <span class="nx">copy</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">rollup-plugin-copy</span><span class="dl">"</span>

<span class="kd">const</span> <span class="nx">production</span> <span class="o">=</span> <span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ROLLUP_WATCH</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">production</span><span class="p">)</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">production</span><span class="dl">"</span>
<span class="kd">const</span> <span class="nx">nodeEnv</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">||</span> <span class="dl">"</span><span class="s2">development</span><span class="dl">"</span>

<span class="k">export</span> <span class="k">default</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">input</span><span class="p">:</span> <span class="dl">"</span><span class="s2">src/background.js</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">output</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">sourcemap</span><span class="p">:</span> <span class="o">!</span><span class="nx">production</span><span class="p">,</span>
      <span class="na">dir</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dist/background/</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">format</span><span class="p">:</span> <span class="dl">"</span><span class="s2">esm</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="na">plugins</span><span class="p">:</span> <span class="p">[</span>
      <span class="nx">replace</span><span class="p">({</span>
        <span class="na">preventAssignment</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">values</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">process.env.NODE_ENV</span><span class="dl">"</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">nodeEnv</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="na">delimiters</span><span class="p">:</span> <span class="p">[</span><span class="dl">""</span><span class="p">,</span> <span class="dl">""</span><span class="p">],</span>
      <span class="p">}),</span>
        
      <span class="nx">resolve</span><span class="p">({</span> <span class="na">browser</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">preferBuiltins</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}),</span>
      <span class="nx">commonjs</span><span class="p">(),</span>

      <span class="nx">copy</span><span class="p">({</span>
        <span class="na">targets</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="na">src</span><span class="p">:</span> <span class="s2">`src/manifest.json`</span><span class="p">,</span>
            <span class="na">dest</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dist/</span><span class="dl">"</span><span class="p">,</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="na">src</span><span class="p">:</span> <span class="dl">"</span><span class="s2">src/background/index.html</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">dest</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dist/background/</span><span class="dl">"</span><span class="p">,</span>
          <span class="p">},</span>
          <span class="p">{</span> <span class="na">src</span><span class="p">:</span> <span class="dl">"</span><span class="s2">src/assets/</span><span class="dl">"</span><span class="p">,</span> <span class="na">dest</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dist/</span><span class="dl">"</span> <span class="p">},</span>
        <span class="p">],</span>
      <span class="p">}),</span>
    <span class="p">],</span>
    <span class="na">watch</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">clearScreen</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">]</span>
</code></pre></div></div>

<p>(One nice thing about Rollup is that the config file can be normal everyday ES6 syntax which means trailing commas, <code class="language-plaintext highlighter-rouge">import</code>/<code class="language-plaintext highlighter-rouge">export</code> statements and destructuring.)</p>

<p>Let’s break this down:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="k">default</span> <span class="p">[</span>
  <span class="c1">// ...</span>
<span class="p">]</span>
</code></pre></div></div>

<p>In Rollup you can export either a single config object or an array of config objects. We’ll jump straight to exporting an array of objects as we’ll add another configuration for the pop-up page later which will include the Svelte plugin and have some different needs around what gets copied over.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nx">input</span><span class="p">:</span> <span class="dl">"</span><span class="s2">src/background/index.js</span><span class="dl">"</span><span class="p">,</span>
    <span class="nx">output</span><span class="p">:</span> <span class="p">{</span>
      <span class="nl">sourcemap</span><span class="p">:</span> <span class="o">!</span><span class="nx">production</span><span class="p">,</span>
      <span class="nx">dir</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dist/background/</span><span class="dl">"</span><span class="p">,</span>
      <span class="nx">format</span><span class="p">:</span> <span class="dl">"</span><span class="s2">esm</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">},</span>
</code></pre></div></div>

<p>Here we’re telling Rollup that we’ll package <code class="language-plaintext highlighter-rouge">src/background/index.js</code> as an ES module (via <code class="language-plaintext highlighter-rouge">format: "esm"</code>), enabling or disabling sourcemaps according to if this is a production build, and place the output into <code class="language-plaintext highlighter-rouge">dist/background</code>. Rollup will take care of creating <code class="language-plaintext highlighter-rouge">dist/</code> and other directories if they doesn’t exist which is why we didn’t bother with creating it before.</p>

<p>Finally let’s take a look at the plugins we’ll be using for <code class="language-plaintext highlighter-rouge">src/background/index.js</code>:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><div class="emphasized">      <span class="nx">replace</span><span class="p">({</span>
<span class="hll">        <span class="na">preventAssignment</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span>        <span class="na">values</span><span class="p">:</span> <span class="p">{</span>
<span class="hll">          <span class="dl">"</span><span class="s2">process.env.NODE_ENV</span><span class="dl">"</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">nodeEnv</span><span class="p">),</span>
</span>        <span class="p">},</span>
      <span class="p">}),</span></div></code></pre></figure>

<p>As stated above, we’ll being using the replace plugin to replace any occurance of <code class="language-plaintext highlighter-rouge">process.env.NODE_ENV</code> with the value of <code class="language-plaintext highlighter-rouge">NODE_ENV</code>. This might seem weird to have to do manually if you’re coming from Webpack or Parcel, but it’s a minimal addition to our config that I don’t mind having. We’re also telling the plugin that if it detects an assignment to <code class="language-plaintext highlighter-rouge">process.env.NODE_ENV</code>, it shouldn’t replace it with our hard coded string, via the <code class="language-plaintext highlighter-rouge">preventAssignment</code> option.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><div class="emphasized">      <span class="nx">resolve</span><span class="p">({</span>
<span class="hll">        <span class="na">browser</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class="hll">        <span class="na">preferBuiltins</span><span class="p">:</span> <span class="kc">false</span>
</span>      <span class="p">}),</span>
<span class="hll">      <span class="nx">commonjs</span><span class="p">(),</span>
</span></div></code></pre></figure>

<p>We need to tell the resolve plugin to act a little differently since we’re bundling for a browser, by using any browser configurations found in imported <code class="language-plaintext highlighter-rouge">package.json</code> and to not try and use Node built ins. We also add support for pulling in CommonJS modules even if we’re bundling as an ESM which will greatly increase the number of npm packages we can make use of.</p>

<p class="callout">I’ve had issues with the node built ins and haven’t been able to get polyfills to work or been able to remove the <code class="language-plaintext highlighter-rouge">preferBuiltins</code> flag. It’s only effected a small number of packages, which I’ve been able to find alternatives for so I just leave this flag in place for now. If anyone has advice on how to get these to play nice together, shoot me a message, I’ll give it a go and update this post!</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><div class="emphasized">      <span class="nx">copy</span><span class="p">({</span>
        <span class="na">targets</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
<span class="hll">            <span class="na">src</span><span class="p">:</span> <span class="s2">`src/manifest.json`</span><span class="p">,</span>
</span>            <span class="na">dest</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dist/</span><span class="dl">"</span><span class="p">,</span>
          <span class="p">},</span>
          <span class="p">{</span>
<span class="hll">            <span class="na">src</span><span class="p">:</span> <span class="dl">"</span><span class="s2">src/background/index.html</span><span class="dl">"</span><span class="p">,</span>
</span>            <span class="na">dest</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dist/background/</span><span class="dl">"</span><span class="p">,</span>
          <span class="p">},</span>
<span class="hll">          <span class="p">{</span> <span class="na">src</span><span class="p">:</span> <span class="dl">"</span><span class="s2">src/assets/</span><span class="dl">"</span><span class="p">,</span> <span class="na">dest</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dist/</span><span class="dl">"</span> <span class="p">},</span>
</span>        <span class="p">],</span>
      <span class="p">}),</span></div></code></pre></figure>

<p>And finally we copy over some files. We don’t want <code class="language-plaintext highlighter-rouge">dist/</code> hanging out in our repository so we’ll copy it over from <code class="language-plaintext highlighter-rouge">src/</code>, so that it stays closer to the files it references. Additionally, we’ll copy over an HTML file for <code class="language-plaintext highlighter-rouge">src/background/index.js</code> to live in (more on this in just a second), and finally we’ll copy over all assets while we’re at it; I throw fonts, SVGs, logos and more into <code class="language-plaintext highlighter-rouge">src/assets/</code>.</p>

<h2 id="setup---browser-extension">Setup - Browser Extension</h2>
<p>We also need to add <code class="language-plaintext highlighter-rouge">src/background/index.js</code> and <code class="language-plaintext highlighter-rouge">src/background/index.html</code>, we’ll talk about why we need both in a little bit, they’ll look like this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello, World!</span><span class="dl">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;title&gt;</span>Web Ext<span class="nt">&lt;/title&gt;</span>

    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"module"</span> <span class="na">src=</span><span class="s">"./index.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;/head&gt;</span>

  <span class="nt">&lt;body&gt;&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">type="module"</code> attribute on the <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> tag is the magic to get our ESM bundle to work.</p>

<p>The last part before we can fire up Rollup and give this a go, the magic <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json"><code class="language-plaintext highlighter-rouge">src/manifest.json</code></a> file:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"manifest_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Web Ext"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">

  </span><span class="nl">"background"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"page"</span><span class="p">:</span><span class="w"> </span><span class="s2">"background/index.html"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">manifest.json</code> file has to appear at the root of the packaged browser extension and informs the browser about the scripts, permissions, and more that the extension requires. For now, the most important bit is the value of the <code class="language-plaintext highlighter-rouge">background</code> key. The <code class="language-plaintext highlighter-rouge">background.page</code> key tells the browser that it doesn’t need to create it’s own generic HTML page and should instead load our HTML from above which will load our script as an <a href="#annotation-4" class="annotation-trigger -gray">ES module without issue.</a>
<span id="annotation-4" class="annotation">If you took a look at the documentation for the <code class="language-plaintext highlighter-rouge">background</code> key in the manifest, you might be a little confused as to why we’re using the <code class="language-plaintext highlighter-rouge">page</code> option and not the <code class="language-plaintext highlighter-rouge">scripts</code> option. As it turns out, the browsers don’t support loading any ES module via the <code class="language-plaintext highlighter-rouge">scripts</code> option at the moment, even if they support ESM for web extensions. To get around this issue, we can create our own HTML page which pulls in our code as a module (with that fancy <code class="language-plaintext highlighter-rouge">type="module"</code> attribute on the <code class="language-plaintext highlighter-rouge">&lt;script /&gt;</code> tag) and then tell the browser to use said page for the extensions background page with the <code class="language-plaintext highlighter-rouge">page</code> option. This isn’t documented on MDN, unfortunately, but there are several other blog posts out there that cover this work around too.</span></p>

<p>Lets add two scripts to our <code class="language-plaintext highlighter-rouge">package.json</code> to help us run Rollup in development and production modes a little easier:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><div class="emphasized"><span class="w">  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">    </span><span class="nl">"start:rollup"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rollup -c -w"</span><span class="p">,</span>
</span><span class="hll"><span class="w">    </span><span class="nl">"build:rollup"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rollup -c"</span>
</span><span class="w">  </span><span class="p">}</span><span class="err">,</span></div></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">-w</code> flag tells Rollup to watch the files and rerun the build if anything changes, which comes in handy with developing and iterating.</p>

<h2 id="but--does-it-run">But … Does it Run?</h2>
<p>With all that done, let us give this extension a go and make sure things are working:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm run start:rollup
</code></pre></div></div>

<p>If everything looks good, you should see something similar to the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rollup v2.52.7
bundles src/background/index.js → dist/background...
created dist/background in 14ms

[2021-07-04 14:59:16] waiting for changes...
</code></pre></div></div>

<p>And now the moment of truth, does it run? We’ll cover both Firefox and Chrome and the process here for loading the development build of the extension won’t change as we add more features and functionality.</p>

<h5 id="firefox">Firefox</h5>
<p>In Firefox, type in <code class="language-plaintext highlighter-rouge">about:debugging</code> into the URL bar and press enter; On the left hand sidebar, select “This Firefox.”</p>

<p><img src="/assets/2021-07-03-web-extensions-with-svelte-and-rollup/firefox-step-1.png" alt="" /></p>

<p>There should be a button labeled “Load Temporary Add-on…” but if it’s not visible, you might need to click on the “Temporary Extensions” section to expand it and display the button.</p>

<p><img src="/assets/2021-07-03-web-extensions-with-svelte-and-rollup/firefox-step-2.png" alt="" /></p>

<p>Click on the button and navigate to your built <code class="language-plaintext highlighter-rouge">dist/</code> directory and select the <code class="language-plaintext highlighter-rouge">manifest.json</code> file to load it your extension.</p>

<p><img src="/assets/2021-07-03-web-extensions-with-svelte-and-rollup/firefox-step-3.png" alt="" /></p>

<p>Next, click on the “Inspect” button on the newly loaded.</p>

<p><img src="/assets/2021-07-03-web-extensions-with-svelte-and-rollup/firefox-step-4.png" alt="" /></p>

<p>This’ll open up a new tab with a developer console and you should see our “Hello, World!” printed out!</p>

<p><img src="/assets/2021-07-03-web-extensions-with-svelte-and-rollup/firefox-step-5.png" alt="" /></p>
<h5 id="chrome">Chrome</h5>
<p>In Chrome, type in <code class="language-plaintext highlighter-rouge">about:extensions</code> into the URL bar and press enter. You might need to make sure that that “Developer mode” switch is turned on in order to see the button “Load unpacked”</p>

<p>Click on “Load unpacked” and navigate to your extensions directory and select the <code class="language-plaintext highlighter-rouge">dist/</code> directory to load your extension.</p>

<p><img src="/assets/2021-07-03-web-extensions-with-svelte-and-rollup/chrome-step-1.png" alt="" /></p>

<p>Next, click on the “background/index.html” link to open the developer console to the background page’s context.</p>

<p><img src="/assets/2021-07-03-web-extensions-with-svelte-and-rollup/chrome-step-2.png" alt="" /></p>

<p>This’ll open a new window with the developer tools for the extensions background page, you might have to navigate to “Console” but you should see out “Hello, World!” printed out just like in Forefox!</p>

<p><img src="/assets/2021-07-03-web-extensions-with-svelte-and-rollup/chrome-step-3.png" alt="" /></p>

<h2 id="thats-all-folks">That’s all, folks</h2>
<p>Well, for this post at least. Stay tuned for more posts in which we’ll continue building off of this foundation and end up with a functional and, potentially, somewhat useful browser extension!</p>]]></content><author><name></name></author><category term="browser-extension" /><category term="rollupjs" /><summary type="html"><![CDATA[This post contains inline annotations/footnotes to help add context, helpful tips or expand upon a tangent in the text. Expand them by clicking or tapping on them Annotations might have their own annotationsSuch as this one! inside of them too. Updated 2021-Oct-23 to cleanup some wording and adjust some formatting things]]></summary></entry><entry><title type="html">Using Github Actions to build a Jekyll 4 site and host it on Github Pages</title><link href="https://joshisa.ninja/2020/10/14/using-github-actions-to-build-a-jekyll-4-site-and-host-it-on-github-pages.html" rel="alternate" type="text/html" title="Using Github Actions to build a Jekyll 4 site and host it on Github Pages" /><published>2020-10-14T00:00:00+00:00</published><updated>2020-10-14T00:00:00+00:00</updated><id>https://joshisa.ninja/2020/10/14/using-github-actions-to-build-a-jekyll-4-site-and-host-it-on-github-pages</id><content type="html" xml:base="https://joshisa.ninja/2020/10/14/using-github-actions-to-build-a-jekyll-4-site-and-host-it-on-github-pages.html"><![CDATA[<p>A while back I decided that I was going to move this site from an older <a href="https://www.getlektor.com/">Lektor</a> setup to <a href="https://jekyllrb.com/">Jekyll</a> while retaining my Github Pages hosting setup. The reasons behind the move are little more than personal preference, but I had hoped to at least rid myself of Travis CI after being unhappy with Idera’s acquisition of it.</p>

<p>I initially planned on taking advantage of the automatic building and hosting of a <a href="https://docs.github.com/en/free-pro-team@latest/github/working-with-github-pages/setting-up-a-github-pages-site-with-jekyll">Jekyll site on Github Pages</a>, however after seeing that I wouldn’t be able to have custom build steps such as using PostCSS for a custom theme and being locked into <a href="https://pages.github.com/versions/">Jekyll 3</a>, I had to find my own way for building and deploying the site. Thankfully that’s an easy task now as a result of Github Actions which let me both ditch Travis CI and not have to worry about getting another CI runner authorized to push to the repo.</p>

<p>A lot of my setup follows the footsteps of <a href="https://davidstosik.github.io/2020/05/31/static-blog-jekyll-410-github-pages-actions.html">David Stosik’s setup</a>, so be sure to give that a read. Additionally, I’m actively modeling my photography page setup after <a href="https://brandur.org/photos">Brandur’s</a> setup and his documentation around how his <a href="https://github.com/brandur/sorg/blob/81eb0a6bdfa891156c7124984306488093cdc6f7/docs/photographs.md">site handles them</a>. I’ll have a follow up post on how the photography side of things works once I get it settled.</p>

<h3 id="github-actions">Github Actions</h3>

<p>If you would like to follow along while reading through my own workflow configuration, you can find it <a href="https://github.com/JoshAshby/joshashby.github.io/blob/source/.github/workflows/github-pages.yml">here</a>.</p>

<p>One of the great things about Github Actions over third-party CI providers is the deep integration with the repository: you can clone, commit and push all out of the box without many issues. This, combined with the reusable and composable actions make it quick and easy to build up powerful workflows.</p>

<p>I should note that these days there are two actions that could be used to simplify some of this:</p>

<ul>
  <li><a href="https://github.com/limjh16/jekyll-action-ts">jekyll-action-ts</a></li>
  <li><a href="https://github.com/peaceiris/actions-gh-pages">actions-gh-pages</a></li>
</ul>

<p>These actions were not around when I started this, and I’m choosing not the migrate over because the setup is simple and I don’t feel that these actions add any value to my setup.</p>

<p>Before we get too far, a small note of how we’ll set things up today: There will be two branches in git, <code class="language-plaintext highlighter-rouge">master</code> and <code class="language-plaintext highlighter-rouge">source</code>. The root <code class="language-plaintext highlighter-rouge">/</code> directory in the <code class="language-plaintext highlighter-rouge">master</code> branch is where the built Github Pages will be served from, and <code class="language-plaintext highlighter-rouge">source</code> stores the Jekyll setup. While we could have the pages served from <code class="language-plaintext highlighter-rouge">_site/</code> in my <code class="language-plaintext highlighter-rouge">source</code> branch, this means that every build will commit to my working branch, leading to some pains with uncesscessary commits on the working branch.</p>

<p>For some different configuration options, take a look at <a href="https://docs.github.com/en/free-pro-team@latest/github/working-with-github-pages/configuring-a-publishing-source-for-your-github-pages-site">these docs</a>.</p>

<p>Thi decision to have two branches means that we’ll need to:</p>
<ul>
  <li>Pull from <code class="language-plaintext highlighter-rouge">source</code></li>
  <li>Build Jekyll</li>
  <li>Commit and Push the built <code class="language-plaintext highlighter-rouge">_site/</code>directory to <code class="language-plaintext highlighter-rouge">master</code></li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">source</span>
</code></pre></div></div>

<p>The first thing we want to do is to limit the workflow to only run when I push to the <code class="language-plaintext highlighter-rouge">source</code> branch, so that we don’t get our CI into a loop. With Github Actions we do this with the <a href="https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#onpushpull_requestbranchestags"><code class="language-plaintext highlighter-rouge">on.push.branches</code></a> setting:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">jobs</span><span class="pi">:</span>
  <span class="na">github-pages</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
</code></pre></div></div>

<p>Next, I personally want to run this on a familiar environment, so we’ll use the built in Github Actions <code class="language-plaintext highlighter-rouge">ubuntu</code> runner, by setting the <a href="https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idruns-on"><code class="language-plaintext highlighter-rouge">jobs.&lt;job-id&gt;.runs-on</code></a> setting (more info on the available runners <a href="https://docs.github.com/en/free-pro-team@latest/actions/reference/workflow-syntax-for-github-actions#jobsjob_idruns-on">here</a>.</p>

<p>The rest of our work will be in the <a href="https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idsteps"><code class="language-plaintext highlighter-rouge">jobs.&lt;job-id&gt;.steps</code></a>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
        <span class="na">with</span><span class="pi">:</span>
<span class="err">				  </span><span class="na">ref</span><span class="pi">:</span> <span class="s">source</span>
          <span class="s">path</span><span class="err">:</span> <span class="s">source</span>

      <span class="s">- uses</span><span class="err">:</span> <span class="s">actions/checkout@v2</span>
        <span class="s">with</span><span class="err">:</span>
          <span class="na">ref</span><span class="pi">:</span> <span class="s">master</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">build</span>
</code></pre></div></div>

<p>These two actions are how we’ll pull from one branch and push to another, doing two checkouts of the repository at different paths for each branch: The <code class="language-plaintext highlighter-rouge">source</code> branch that’ll we’ll use to build the Jekyll site lives at <code class="language-plaintext highlighter-rouge">./source</code> and the <code class="language-plaintext highlighter-rouge">master</code> branch at <code class="language-plaintext highlighter-rouge">./build</code>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-ruby@v1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">ruby-version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2.7'</span>

      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-node@v1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">node-version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">16.4.x'</span>
</code></pre></div></div>

<p>We’ll need ruby, and my own setup needs node so lets get those installed.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/cache@v2</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">source/vendor/bundle</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}</span>
          <span class="na">restore-keys</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">${{ runner.os }}-gems-</span>

      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/cache@v2</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">source/node_modules</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">${{ runner.os }}-npm-${{ hashFiles('**/yarn.lock') }}</span>
          <span class="na">restore-keys</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">${{ runner.os }}-npm-</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Bundle install</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">source</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">gem install bundler --no-document</span>
          <span class="s">bundle config path vendor/bundle</span>
          <span class="s">bundle install --jobs 4 --retry 3</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Yarn install</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">source</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">yarn install</span>
</code></pre></div></div>

<p>And now we’ll install the dependences in <code class="language-plaintext highlighter-rouge">./source</code>. We’ll use the cache actions to ensure that our dependencies are quick to install leading to faster publishing, and use the hash of the lockfiles to determine which cache to restore.</p>

<p>Now we get to the heart of the workflow, building and publishing the site:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Jekyll Build</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">source</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="na">JEKYLL_ENV</span><span class="pi">:</span> <span class="s">production</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">bundle exec jekyll build -d ../build</span>
</code></pre></div></div>

<p>Instead of building to Jekylls default <code class="language-plaintext highlighter-rouge">_site</code>, we’ll have it build to our checked out <code class="language-plaintext highlighter-rouge">master</code> branch, at <code class="language-plaintext highlighter-rouge">../build</code> from inside of <code class="language-plaintext highlighter-rouge">./source</code>.</p>

<p>And finally we’ll publish the site by making a new commit to <code class="language-plaintext highlighter-rouge">master</code> and push it to the repository with a helpful commit message linking the build back to the <code class="language-plaintext highlighter-rouge">source</code> commit that triggered it, and set the commiter to show up as your own user on Github:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Commit and push changes to master</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">build</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">git config user.name "${GITHUB_ACTOR}"</span>
          <span class="s">git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"</span>
          <span class="s">git add .</span>
          <span class="s">git commit -m "Update GitHub pages from Jekyll build for commit ${GITHUB_SHA}"</span>
          <span class="s">git push origin master</span>
</code></pre></div></div>

<p>And that’s it! It might look like a lot all spaced out like this, but it’s a fairly simple setup that is still powerful and expandable as you add more features to your site such as photograph processing, javascript resource processing or html cleanup in <code class="language-plaintext highlighter-rouge">./build</code> before publishing.</p>]]></content><author><name></name></author><category term="github actions" /><category term="jekyll" /><summary type="html"><![CDATA[A while back I decided that I was going to move this site from an older Lektor setup to Jekyll while retaining my Github Pages hosting setup. The reasons behind the move are little more than personal preference, but I had hoped to at least rid myself of Travis CI after being unhappy with Idera’s acquisition of it.]]></summary></entry><entry><title type="html">All Things Old</title><link href="https://joshisa.ninja/2020/10/13/all-things-old.html" rel="alternate" type="text/html" title="All Things Old" /><published>2020-10-13T14:30:00+00:00</published><updated>2020-10-13T14:30:00+00:00</updated><id>https://joshisa.ninja/2020/10/13/all-things-old</id><content type="html" xml:base="https://joshisa.ninja/2020/10/13/all-things-old.html"><![CDATA[<p>At this rate, I should get an award for time wasted recreating this site in various failed attempts at finding a setup that sits well with me. At one point in time, it was a static site hosted on some random but free service and built with WYSIWYG tools like KompoZer, NVU, and Bluefish and making liberal use of image maps and amazing Web 2.0 graphics. Then it was a WordPress site. Then a static site, then another WordPress site, somewhere there was a Tumblr version … You get the picture. Many of these evolutions came stemmed from being unhappy or incapable of maintaining the site’s state due to time, neglect, or merely a lack of knowledge. It should also be noted that this all happened in the timespan of not months but years, nearly 15. However, during all of the iterations, I’ve grown both in working knowledge around running servers and hosting websites and personal experience around what works for me and what I want out of a personal site.  And thus we arrive at today and yet another incarnation of this site.</p>

<p>During the ongoing COVID-19 pandemic, I’ve had a lot of time to think, dangerous amounts sometimes, and I’ve decided to explore more technically focused writing in some capacity. Now, whether that’s through breakdowns of something I wrote or doing dives into some project internals to explain some of the moving parts, who knows (I certainly don’t yet). So, this iterations theme is “throw some mud and see what sticks.” Hopefully, I can find a region that I fit into and have enough self-accountability to do a post once a month. This approach ties in nicely with my natural desire to explore and learn: I often go on deep dives into projects and try out different languages and programming paradigms. There isn’t anything blocking me from just writing down those learnings and sharing them with the world through another set of eyes. To kick this off, I’m working on a few new posts that I’m going to hold myself accountable to get done by the end of this year:</p>

<ul>
  <li>A walkthrough of the setup for this site and how I’m using Jekyll, Github Actions, and Github Pages to build and host it in a no-frills way</li>
  <li>A walkthrough of how I set up a personal server with Traefik and Docker for painless but flexible deploys of modest personal tools</li>
  <li>A dive into building out some new frontend UI for my personal bookmarking site <a href="https://transientbug.ninja">transientBug</a></li>
</ul>

<p>Additionally, I’ve always felt uneasy about feeding into the walled gardens of platforms for creative outlets such as photography. Historically, I haven’t had a good place to publish and no workflow that has felt right, so  I spent time thinking about that process and reading up on how others have set up theirs. I think I’ve got a starting point that should enable me to share some more of my work with the world. We’ll see.</p>

<p>I haven’t fully explored what I want out of this site, so the ride might be bumpy. It’s sure to be slow, probably half-baked at first, and feel a little forced as well. Still, I’m hopeful I can evolve it to match my desire to share my adventures in expanding my knowledge.</p>]]></content><author><name></name></author><summary type="html"><![CDATA[At this rate, I should get an award for time wasted recreating this site in various failed attempts at finding a setup that sits well with me. At one point in time, it was a static site hosted on some random but free service and built with WYSIWYG tools like KompoZer, NVU, and Bluefish and making liberal use of image maps and amazing Web 2.0 graphics. Then it was a WordPress site. Then a static site, then another WordPress site, somewhere there was a Tumblr version … You get the picture. Many of these evolutions came stemmed from being unhappy or incapable of maintaining the site’s state due to time, neglect, or merely a lack of knowledge. It should also be noted that this all happened in the timespan of not months but years, nearly 15. However, during all of the iterations, I’ve grown both in working knowledge around running servers and hosting websites and personal experience around what works for me and what I want out of a personal site. And thus we arrive at today and yet another incarnation of this site.]]></summary></entry></feed>